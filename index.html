<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø§Ù„ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-7xl mx-auto bg-white rounded-lg shadow-lg">
        <div class="bg-indigo-600 text-white p-6 rounded-t-lg flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold">Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø§Ù„ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</h1>
                <p class="mt-2">Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø´ØªØ±ÛŒØ§Ù†ØŒ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ Ùˆ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</p>
            </div>
            <button id="btn-export" class="bg-white text-indigo-600 px-6 py-3 rounded-lg font-bold hover:bg-gray-100">
                ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Excel
            </button>
        </div>

        <div class="grid grid-cols-4 gap-4 p-6 bg-gray-50">
            <div class="bg-green-100 p-4 rounded-lg">
                <p class="text-sm text-gray-600">Ú©Ù„ Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø§Ø² Ù…Ø´ØªØ±ÛŒØ§Ù†</p>
                <p id="stat-received" class="text-2xl font-bold text-green-600">0 AED</p>
            </div>
            <div class="bg-orange-100 p-4 rounded-lg">
                <p class="text-sm text-gray-600">Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØªÛŒ</p>
                <p id="stat-remaining" class="text-2xl font-bold text-orange-600">0 AED</p>
            </div>
            <div class="bg-red-100 p-4 rounded-lg">
                <p class="text-sm text-gray-600">Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ</p>
                <p id="stat-paid" class="text-2xl font-bold text-red-600">0 AED</p>
            </div>
            <div class="bg-blue-100 p-4 rounded-lg">
                <p class="text-sm text-gray-600">Ø³ÙˆØ¯ Ø®Ø§Ù„Øµ</p>
                <p id="stat-profit" class="text-2xl font-bold text-blue-600">0 AED</p>
            </div>
        </div>

        <div class="flex border-b">
            <button class="tab-btn px-6 py-3 font-bold text-indigo-600 border-b-2 border-indigo-600" data-tab="customers">Ù…Ø´ØªØ±ÛŒØ§Ù† Ùˆ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§</button>
            <button class="tab-btn px-6 py-3 text-gray-600" data-tab="payments">Ø¯Ø±ÛŒØ§ÙØªâ€ŒÙ‡Ø§</button>
            <button class="tab-btn px-6 py-3 text-gray-600" data-tab="expenses">Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ (Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§)</button>
            <button class="tab-btn px-6 py-3 text-gray-600" data-tab="reports">Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</button>
        </div>

        <div class="p-6">
            <!-- Customers Tab -->
            <div id="tab-customers" class="tab-content">
                <div class="mb-4 flex justify-between">
                    <h2 class="text-xl font-bold">Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø´ØªØ±ÛŒØ§Ù†</h2>
                    <button id="btn-add-customer" class="bg-indigo-600 text-white px-4 py-2 rounded">+ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯</button>
                </div>

                <div id="form-customer" class="hidden bg-blue-50 p-4 rounded-lg mb-4">
                    <h3 class="font-bold mb-3">Ø«Ø¨Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯</h3>
                    <div class="grid grid-cols-4 gap-3 mb-3">
                        <input type="text" id="inp-cust-name" placeholder="Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ *" class="border p-2 rounded">
                        <input type="text" id="inp-cust-project" placeholder="Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡ *" class="border p-2 rounded">
                        <input type="number" id="inp-cust-total" placeholder="Ù…Ø¨Ù„Øº Ú©Ù„ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ (AED) *" class="border p-2 rounded">
                        <input type="text" id="inp-cust-desc" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª" class="border p-2 rounded">
                    </div>
                    <input type="hidden" id="edit-customer-id">
                    <button id="btn-save-customer" class="bg-green-600 text-white px-4 py-2 rounded">Ø°Ø®ÛŒØ±Ù‡</button>
                    <button id="btn-cancel-customer" class="bg-gray-400 text-white px-4 py-2 rounded mr-2">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>

                <div id="customers-list" class="grid grid-cols-1 gap-4"></div>
            </div>

            <!-- Payments Tab -->
            <div id="tab-payments" class="tab-content hidden">
                <div class="mb-4 flex justify-between">
                    <h2 class="text-xl font-bold">Ø¯Ø±ÛŒØ§ÙØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø´ØªØ±ÛŒØ§Ù† (Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø³Ø·ÛŒ)</h2>
                    <button id="btn-add-payment" class="bg-green-600 text-white px-4 py-2 rounded">+ Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø¯ÛŒØ¯</button>
                </div>

                <div id="form-payment" class="hidden bg-green-50 p-4 rounded-lg mb-4">
                    <h3 class="font-bold mb-3">Ø«Ø¨Øª Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø¬Ø¯ÛŒØ¯</h3>
                    <div class="grid grid-cols-3 gap-3 mb-3">
                        <select id="inp-pay-customer" class="border p-2 rounded">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ/Ù¾Ø±ÙˆÚ˜Ù‡ *</option>
                        </select>
                        <input type="number" id="inp-pay-amount" placeholder="Ù…Ø¨Ù„Øº Ø¯Ø±ÛŒØ§ÙØªÛŒ (AED) *" class="border p-2 rounded">
                        <input type="text" id="inp-pay-note" placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øª" class="border p-2 rounded">
                    </div>
                    <button id="btn-save-payment" class="bg-green-600 text-white px-4 py-2 rounded">Ø«Ø¨Øª Ø¯Ø±ÛŒØ§ÙØª</button>
                    <button id="btn-cancel-payment" class="bg-gray-400 text-white px-4 py-2 rounded mr-2">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>

                <table class="w-full border">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 text-right">ØªØ§Ø±ÛŒØ®</th>
                            <th class="p-2 text-right">Ù…Ø´ØªØ±ÛŒ/Ù¾Ø±ÙˆÚ˜Ù‡</th>
                            <th class="p-2 text-right">Ù…Ø¨Ù„Øº Ø¯Ø±ÛŒØ§ÙØªÛŒ</th>
                            <th class="p-2 text-right">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</th>
                            <th class="p-2 text-right">Ø­Ø°Ù</th>
                        </tr>
                    </thead>
                    <tbody id="payments-list"></tbody>
                </table>
            </div>

            <!-- Expenses Tab -->
            <div id="tab-expenses" class="tab-content hidden">
                <div class="mb-4 flex justify-between">
                    <h2 class="text-xl font-bold">Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ (Ø¨Ù‡ Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±/Ú©Ø§Ø±Ú¯Ø±)</h2>
                    <button id="btn-add-expense" class="bg-red-600 text-white px-4 py-2 rounded">+ Ù‡Ø²ÛŒÙ†Ù‡ Ø¬Ø¯ÛŒØ¯</button>
                </div>

                <div id="form-expense" class="hidden bg-red-50 p-4 rounded-lg mb-4">
                    <h3 class="font-bold mb-3">Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡ Ø¬Ø¯ÛŒØ¯</h3>
                    <div class="grid grid-cols-4 gap-3 mb-3">
                        <select id="inp-exp-customer" class="border p-2 rounded">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø±ÙˆÚ˜Ù‡ *</option>
                        </select>
                        <input type="text" id="inp-exp-desc" placeholder="Ø´Ø±Ø­ Ù‡Ø²ÛŒÙ†Ù‡ *" class="border p-2 rounded">
                        <input type="number" id="inp-exp-amount" placeholder="Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ (AED) *" class="border p-2 rounded">
                        <input type="text" id="inp-exp-to" placeholder="Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ù‡ Ú†Ù‡ Ú©Ø³ÛŒ" class="border p-2 rounded">
                    </div>
                    <button id="btn-save-expense" class="bg-green-600 text-white px-4 py-2 rounded">Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡</button>
                    <button id="btn-cancel-expense" class="bg-gray-400 text-white px-4 py-2 rounded mr-2">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>

                <table class="w-full border">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 text-right">ØªØ§Ø±ÛŒØ®</th>
                            <th class="p-2 text-right">Ù¾Ø±ÙˆÚ˜Ù‡</th>
                            <th class="p-2 text-right">Ø´Ø±Ø­</th>
                            <th class="p-2 text-right">Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ù‡</th>
                            <th class="p-2 text-right">Ù…Ø¨Ù„Øº</th>
                            <th class="p-2 text-right">Ø­Ø°Ù</th>
                        </tr>
                    </thead>
                    <tbody id="expenses-list"></tbody>
                </table>
            </div>

            <!-- Reports Tab -->
            <div id="tab-reports" class="tab-content hidden">
                <h2 class="text-xl font-bold mb-4">Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§</h2>
                <div class="overflow-x-auto">
                    <table class="w-full border text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 text-right">Ú©Ø¯</th>
                                <th class="p-2 text-right">Ù…Ø´ØªØ±ÛŒ</th>
                                <th class="p-2 text-right">Ù¾Ø±ÙˆÚ˜Ù‡</th>
                                <th class="p-2 text-right">Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ú©Ù„</th>
                                <th class="p-2 text-right">Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù‡</th>
                                <th class="p-2 text-right">Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡</th>
                                <th class="p-2 text-right">Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</th>
                                <th class="p-2 text-right">Ø³ÙˆØ¯</th>
                                <th class="p-2 text-right">ÙˆØ¶Ø¹ÛŒØª</th>
                            </tr>
                        </thead>
                        <tbody id="reports-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let customers = JSON.parse(localStorage.getItem('customers2') || '[]');
        let payments = JSON.parse(localStorage.getItem('payments2') || '[]');
        let expenses = JSON.parse(localStorage.getItem('expenses2') || '[]');

        function save() {
            localStorage.setItem('customers2', JSON.stringify(customers));
            localStorage.setItem('payments2', JSON.stringify(payments));
            localStorage.setItem('expenses2', JSON.stringify(expenses));
        }

        function fmt(n) {
            return new Intl.NumberFormat('en-US').format(n) + ' AED';
        }

        function getDate() {
            return new Date().toLocaleDateString('en-GB');
        }

        function getPayments(cid) {
            return payments.filter(p => p.cid === cid).reduce((s, p) => s + p.amount, 0);
        }

        function getExpenses(cid) {
            return expenses.filter(e => e.cid === cid).reduce((s, e) => s + e.amount, 0);
        }

        function updateStats() {
            const totalContract = customers.reduce((s, c) => s + c.total, 0);
            const totalReceived = payments.reduce((s, p) => s + p.amount, 0);
            const totalPaid = expenses.reduce((s, e) => s + e.amount, 0);
            const remaining = totalContract - totalReceived;
            const profit = totalReceived - totalPaid;

            document.getElementById('stat-received').textContent = fmt(totalReceived);
            document.getElementById('stat-remaining').textContent = fmt(remaining);
            document.getElementById('stat-paid').textContent = fmt(totalPaid);
            document.getElementById('stat-profit').textContent = fmt(profit);
        }

        function renderCustomers() {
            const list = document.getElementById('customers-list');
            if (customers.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 py-8">Ù‡ÛŒÚ† Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p>';
                return;
            }
            list.innerHTML = customers.map((c, i) => {
                const received = getPayments(c.id);
                const paid = getExpenses(c.id);
                const remaining = c.total - received;
                const profit = received - paid;
                
                let statusColor = 'bg-gray-200';
                let statusText = 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±';
                if (remaining === 0 && received > 0) {
                    statusColor = 'bg-green-200 text-green-800';
                    statusText = 'ØªØ³ÙˆÛŒÙ‡ Ø´Ø¯Ù‡';
                } else if (received > 0) {
                    statusColor = 'bg-yellow-200 text-yellow-800';
                    statusText = 'Ù‚Ø³Ø·ÛŒ';
                }

                return `<div class="border rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="bg-indigo-100 px-2 py-1 rounded text-sm font-bold">Ú©Ø¯ ${i + 1}</span>
                            <span class="${statusColor} px-2 py-1 rounded text-sm mr-2">${statusText}</span>
                        </div>
                        <div>
                            <button onclick="editCustomer(${c.id})" class="text-blue-600 ml-2">âœï¸</button>
                            <button onclick="delCustomer(${c.id})" class="text-red-600">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <h3 class="font-bold text-lg">${c.name}</h3>
                    <p class="text-gray-600 mb-3">${c.project}</p>
                    ${c.desc ? `<p class="text-sm text-gray-500 mb-3">${c.desc}</p>` : ''}
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="bg-blue-50 p-2 rounded">
                            <p class="text-gray-600">Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ú©Ù„</p>
                            <p class="font-bold text-blue-600">${fmt(c.total)}</p>
                        </div>
                        <div class="bg-green-50 p-2 rounded">
                            <p class="text-gray-600">Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù‡</p>
                            <p class="font-bold text-green-600">${fmt(received)}</p>
                        </div>
                        <div class="${remaining > 0 ? 'bg-orange-50' : 'bg-gray-50'} p-2 rounded">
                            <p class="text-gray-600">Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡</p>
                            <p class="font-bold ${remaining > 0 ? 'text-orange-600' : 'text-gray-600'}">${fmt(remaining)}</p>
                        </div>
                        <div class="bg-red-50 p-2 rounded">
                            <p class="text-gray-600">Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</p>
                            <p class="font-bold text-red-600">${fmt(paid)}</p>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t">
                        <div class="flex justify-between items-center">
                            <span class="font-bold">Ø³ÙˆØ¯:</span>
                            <span class="font-bold text-lg ${profit >= 0 ? 'text-green-600' : 'text-red-600'}">${fmt(profit)}</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderPayments() {
            const list = document.getElementById('payments-list');
            if (payments.length === 0) {
                list.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">Ù‡ÛŒÚ† Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</td></tr>';
                return;
            }
            list.innerHTML = payments.map(p => {
                const c = customers.find(x => x.id === p.cid);
                return `<tr class="border-t hover:bg-gray-50">
                    <td class="p-2">${p.date}</td>
                    <td class="p-2">${c ? c.name + ' - ' + c.project : 'Ù†Ø§Ù…Ø´Ø®Øµ'}</td>
                    <td class="p-2 font-bold text-green-600">${fmt(p.amount)}</td>
                    <td class="p-2 text-gray-600">${p.note || '-'}</td>
                    <td class="p-2"><button onclick="delPayment(${p.id})" class="text-red-600">ğŸ—‘ï¸</button></td>
                </tr>`;
            }).join('');
        }

        function renderExpenses() {
            const list = document.getElementById('expenses-list');
            if (expenses.length === 0) {
                list.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-gray-500">Ù‡ÛŒÚ† Ù‡Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</td></tr>';
                return;
            }
            list.innerHTML = expenses.map(e => {
                const c = customers.find(x => x.id === e.cid);
                return `<tr class="border-t hover:bg-gray-50">
                    <td class="p-2">${e.date}</td>
                    <td class="p-2">${c ? c.project : 'Ù†Ø§Ù…Ø´Ø®Øµ'}</td>
                    <td class="p-2">${e.desc}</td>
                    <td class="p-2 text-gray-600">${e.to || '-'}</td>
                    <td class="p-2 font-bold text-red-600">${fmt(e.amount)}</td>
                    <td class="p-2"><button onclick="delExpense(${e.id})" class="text-red-600">ğŸ—‘ï¸</button></td>
                </tr>`;
            }).join('');
        }

        function renderReports() {
            const list = document.getElementById('reports-list');
            if (customers.length === 0) {
                list.innerHTML = '<tr><td colspan="9" class="text-center p-4 text-gray-500">Ù‡ÛŒÚ† Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</td></tr>';
                return;
            }
            list.innerHTML = customers.map((c, i) => {
                const received = getPayments(c.id);
                const paid = getExpenses(c.id);
                const remaining = c.total - received;
                const profit = received - paid;
                
                let status = 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø±ÛŒØ§ÙØª';
                let statusColor = 'text-gray-600';
                if (remaining === 0) {
                    status = 'âœ… ØªØ³ÙˆÛŒÙ‡ Ú©Ø§Ù…Ù„';
                    statusColor = 'text-green-600';
                } else if (received > 0) {
                    status = 'â³ Ù‚Ø³Ø·ÛŒ';
                    statusColor = 'text-yellow-600';
                }

                return `<tr class="border-t hover:bg-gray-50">
                    <td class="p-2">${i + 1}</td>
                    <td class="p-2 font-medium">${c.name}</td>
                    <td class="p-2">${c.project}</td>
                    <td class="p-2 text-blue-600 font-bold">${fmt(c.total)}</td>
                    <td class="p-2 text-green-600 font-bold">${fmt(received)}</td>
                    <td class="p-2 ${remaining > 0 ? 'text-orange-600' : 'text-gray-600'} font-bold">${fmt(remaining)}</td>
                    <td class="p-2 text-red-600 font-bold">${fmt(paid)}</td>
                    <td class="p-2 font-bold ${profit >= 0 ? 'text-green-600' : 'text-red-600'}">${fmt(profit)}</td>
                    <td class="p-2 ${statusColor}">${status}</td>
                </tr>`;
            }).join('');
        }

        function updateSelects() {
            const opts = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>' + 
                customers.map((c, i) => `<option value="${c.id}">Ú©Ø¯ ${i + 1} - ${c.name} (${c.project})</option>`).join('');
            document.getElementById('inp-pay-customer').innerHTML = opts;
            document.getElementById('inp-exp-customer').innerHTML = opts;
        }

        window.editCustomer = function(id) {
            const c = customers.find(x => x.id === id);
            if (!c) return;
            document.getElementById('inp-cust-name').value = c.name;
            document.getElementById('inp-cust-project').value = c.project;
            document.getElementById('inp-cust-total').value = c.total;
            document.getElementById('inp-cust-desc').value = c.desc || '';
            document.getElementById('edit-customer-id').value = id;
            document.getElementById('form-customer').classList.remove('hidden');
            window.scrollTo(0, 200);
        };

        window.delCustomer = function(id) {
            if (!confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ ØªÙ…Ø§Ù… Ø¯Ø±ÛŒØ§ÙØªâ€ŒÙ‡Ø§ Ùˆ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ Ù‡Ù… Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯.')) return;
            customers = customers.filter(c => c.id !== id);
            payments = payments.filter(p => p.cid !== id);
            expenses = expenses.filter(e => e.cid !== id);
            save();
            renderCustomers();
            updateStats();
        };

        window.delPayment = function(id) {
            if (!confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
            payments = payments.filter(p => p.id !== id);
            save();
            renderPayments();
            renderCustomers();
            updateStats();
        };

        window.delExpense = function(id) {
            if (!confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
            expenses = expenses.filter(e => e.id !== id);
            save();
            renderExpenses();
            renderCustomers();
            updateStats();
        };

        // Tabs
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tab = this.dataset.tab;
                document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('text-indigo-600', 'border-b-2', 'border-indigo-600', 'font-bold');
                    b.classList.add('text-gray-600');
                });
                document.getElementById('tab-' + tab).classList.remove('hidden');
                this.classList.add('text-indigo-600', 'border-b-2', 'border-indigo-600', 'font-bold');
                this.classList.remove('text-gray-600');
                if (tab === 'reports') renderReports();
            });
        });

        // Customer Form
        document.getElementById('btn-add-customer').addEventListener('click', () => {
            document.getElementById('edit-customer-id').value = '';
            document.getElementById('form-customer').classList.remove('hidden');
        });

        document.getElementById('btn-cancel-customer').addEventListener('click', () => {
            document.getElementById('form-customer').classList.add('hidden');
            document.getElementById('inp-cust-name').value = '';
            document.getElementById('inp-cust-project').value = '';
            document.getElementById('inp-cust-total').value = '';
            document.getElementById('inp-cust-desc').value = '';
            document.getElementById('edit-customer-id').value = '';
        });

        document.getElementById('btn-save-customer').addEventListener('click', () => {
            const name = document.getElementById('inp-cust-name').value.trim();
            const project = document.getElementById('inp-cust-project').value.trim();
            const total = parseFloat(document.getElementById('inp-cust-total').value);
            const desc = document.getElementById('inp-cust-desc').value.trim();
            const editId = document.getElementById('edit-customer-id').value;

            if (!name || !project || !total) {
                alert('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù…ØŒ Ù¾Ø±ÙˆÚ˜Ù‡ Ùˆ Ù…Ø¨Ù„Øº Ú©Ù„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            if (editId) {
                const c = customers.find(x => x.id == editId);
                c.name = name;
                c.project = project;
                c.total = total;
                c.desc = desc;
            } else {
                customers.push({
                    id: Date.now(),
                    name, project, total, desc,
                    date: getDate()
                });
            }

            save();
            document.getElementById('btn-cancel-customer').click();
            renderCustomers();
            updateStats();
            updateSelects();
        });

        // Payment Form
        document.getElementById('btn-add-payment').addEventListener('click', () => {
            updateSelects();
            document.getElementById('form-payment').classList.remove('hidden');
        });

        document.getElementById('btn-cancel-payment').addEventListener('click', () => {
            document.getElementById('form-payment').classList.add('hidden');
        });

        document.getElementById('btn-save-payment').addEventListener('click', () => {
            const cid = parseInt(document.getElementById('inp-pay-customer').value);
            const amount = parseFloat(document.getElementById('inp-pay-amount').value);
            const note = document.getElementById('inp-pay-note').value.trim();

            if (!cid || !amount) {
                alert('Ù„Ø·ÙØ§Ù‹ Ù…Ø´ØªØ±ÛŒ Ùˆ Ù…Ø¨Ù„Øº Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            payments.push({
                id: Date.now(),
                cid, amount, note,
                date: getDate()
            });

            save();
            document.getElementById('inp-pay-customer').value = '';
            document.getElementById('inp-pay-amount').value = '';
            document.getElementById('inp-pay-note').value = '';
            document.getElementById('form-payment').classList.add('hidden');
            renderPayments();
            renderCustomers();
            updateStats();
        });

        // Expense Form
        document.getElementById('btn-add-expense').addEventListener('click', () => {
            updateSelects();
            document.getElementById('form-expense').classList.remove('hidden');
        });

        document.getElementById('btn-cancel-expense').addEventListener('click', () => {
            document.getElementById('form-expense').classList.add('hidden');
        });

        document.getElementById('btn-save-expense').addEventListener('click', () => {
            const cid = parseInt(document.getElementById('inp-exp-customer').value);
            const desc = document.getElementById('inp-exp-desc').value.trim();
            const amount = parseFloat(document.getElementById('inp-exp-amount').value);
            const to = document.getElementById('inp-exp-to').value.trim();

            if (!cid || !desc || !amount) {
                alert('Ù„Ø·ÙØ§Ù‹ Ù¾Ø±ÙˆÚ˜Ù‡ØŒ Ø´Ø±Ø­ Ùˆ Ù…Ø¨Ù„Øº Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            expenses.push({
                id: Date.now(),
                cid, desc, amount, to,
                date: getDate()
            });

            save();
            document.getElementById('inp-exp-customer').value = '';
            document.getElementById('inp-exp-desc').value = '';
            document.getElementById('inp-exp-amount').value = '';
            document.getElementById('inp-exp-to').value = '';
            document.getElementById('form-expense').classList.add('hidden');
            renderExpenses();
            renderCustomers();
            updateStats();
        });

        // Export Excel
        document.getElementById('btn-export').addEventListener('click', () => {
            let csv = '\ufeffÚ¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„ Ù…Ø§Ù„ÛŒ\n\n';
            csv += 'ØªØ§Ø±ÛŒØ® Ú¯Ø²Ø§Ø±Ø´:,' + getDate() + '\n\n';
            
            csv += 'Ø®Ù„Ø§ØµÙ‡ Ù…Ø§Ù„ÛŒ:\n';
            const totalContract = customers.reduce((s, c) => s + c.total, 0);
            const totalReceived = payments.reduce((s, p) => s + p.amount, 0);
            const totalPaid = expenses.reduce((s, e) => s + e.amount, 0);
            const remaining = totalContract - totalReceived;
            const profit = totalReceived - totalPaid;
            
            csv += 'Ú©Ù„ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§,' + totalContract + '\n';
            csv += 'Ú©Ù„ Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø§Ø² Ù…Ø´ØªØ±ÛŒØ§Ù†,' + totalReceived + '\n';
            csv += 'Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØªÛŒ,' + remaining + '\n';
            csv += 'Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ (Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§),' + totalPaid + '\n';
            csv += 'Ø³ÙˆØ¯ Ø®Ø§Ù„Øµ,' + profit + '\n\n';
            
            csv += 'Ú¯Ø²Ø§Ø±Ø´ ØªÙØµÛŒÙ„ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§:\n';
            csv += 'Ú©Ø¯,Ù…Ø´ØªØ±ÛŒ,Ù¾Ø±ÙˆÚ˜Ù‡,Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ú©Ù„,Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù‡,Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡,Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ,Ø³ÙˆØ¯,ÙˆØ¶Ø¹ÛŒØª\n';
            
            customers.forEach((c, i) => {
                const received = getPayments(c.id);
                const paid = getExpenses(c.id);
                const rem = c.total - received;
                const prof = received - paid;
                let status = rem === 0 ? 'ØªØ³ÙˆÛŒÙ‡ Ø´Ø¯Ù‡' : (received > 0 ? 'Ù‚Ø³Ø·ÛŒ' : 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±');
                csv += `${i + 1},${c.name},${c.project},${c.total},${received},${rem},${paid},${prof},${status}\n`;
            });
            
            csv += '\n\nØ¯Ø±ÛŒØ§ÙØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø´ØªØ±ÛŒØ§Ù†:\n';
            csv += 'ØªØ§Ø±ÛŒØ®,Ù…Ø´ØªØ±ÛŒ,Ù¾Ø±ÙˆÚ˜Ù‡,Ù…Ø¨Ù„Øº,ÛŒØ§Ø¯Ø¯Ø§Ø´Øª\n';
            payments.forEach(p => {
                const c = customers.find(x => x.id === p.cid);
                csv += `${p.date},${c ? c.name : ''},${c ? c.project : ''},${p.amount},${p.note || ''}\n`;
            });
            
            csv += '\n\nÙ‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ:\n';
            csv += 'ØªØ§Ø±ÛŒØ®,Ù¾Ø±ÙˆÚ˜Ù‡,Ø´Ø±Ø­,Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ù‡,Ù…Ø¨Ù„Øº\n';
            expenses.forEach(e => {
                const c = customers.find(x => x.id === e.cid);
                csv += `${e.date},${c ? c.project : ''},${e.desc},${e.to || ''},${e.amount}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'financial_report_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        });

        // Initialize
        renderCustomers();
        renderPayments();
        renderExpenses();
        updateStats();
        updateSelects();
